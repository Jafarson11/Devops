
pipeline {
    agent any
    
    environment {
        AZURE_SUBSCRIPTION_ID = credentials('azure-subscription-id')
        AZURE_TENANT_ID = credentials('azure-tenant-id')
        AZURE_CLIENT_ID = credentials('azure-client-id')
        AZURE_CLIENT_SECRET = credentials('azure-client-secret')
        APP_NAME = 'devops-webapp-yourname123'
        RESOURCE_GROUP = 'devops-project-rg'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo '‚úÖ Checking out code from GitHub...'
                checkout scm
            }
        }
        
        stage('Azure Login') {
            steps {
                echo 'üîê Logging into Azure...'
                bat '''
                    az login --service-principal -u %AZURE_CLIENT_ID% -p %AZURE_CLIENT_SECRET% --tenant %AZURE_TENANT_ID%
                    az account set --subscription %AZURE_SUBSCRIPTION_ID%
                '''
            }
        }
        
        stage('Verify Infrastructure') {
            steps {
                echo 'üîç Verifying Azure infrastructure exists...'
                bat '''
                    az group show --name %RESOURCE_GROUP%
                    az webapp show --name %APP_NAME% --resource-group %RESOURCE_GROUP%
                '''
            }
        }
        
        stage('Build Application') {
            steps {
                echo 'üî® Installing Python dependencies...'
                dir('app') {
                    bat '''
                        pip install --upgrade pip
                        pip install -r requirements.txt
                    '''
                }
            }
        }
        
        stage('Deploy to Azure App Service') {
            steps {
                echo 'üöÄ Deploying Flask application to Azure...'
                dir('app') {
                    bat '''
                        az webapp up --name %APP_NAME% --resource-group %RESOURCE_GROUP% --runtime PYTHON:3.9 --location eastasia --sku B1
                    '''
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                echo '‚úÖ Verifying deployment...'
                bat '''
                    az webapp show --name %APP_NAME% --resource-group %RESOURCE_GROUP% --query "defaultHostName" -o tsv
                '''
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ‚úÖ‚úÖ Pipeline executed successfully! ‚úÖ‚úÖ‚úÖ'
            echo 'üåê Application URL: https://%APP_NAME%.azurewebsites.net'
        }
        failure {
            echo '‚ùå Pipeline execution failed!'
        }
        always {
            echo 'üßπ Cleaning up workspace...'
        }
    }
}
